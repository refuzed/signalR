@{
    ViewBag.Title = "Image2";
}

<h2>Image2</h2>

<input type="button" id="openme" value="open me in another window" />

<div  width="700" height="400">
    <canvas id="canvas" width="700" height="400" style="border: 2px solid black"> </canvas>
</div>

@section scripts {

    <script src="~/Scripts/jquery.signalR-1.1.2.js"></script>
    <script src="~/Scripts/jcanvas.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        count = 0;
        sending = false;
        $('body').addClass("nohighlight");

        $('#canvas').drawRect({
            fillStyle: "#ddd",
            x: 0, y: 0,
            width: $('#canvas').width(),
            height: $('#canvas').height(),
            fromCenter: false
        });

        $(function () {
            var image = $.connection.imageHub;

            image.client.paintXY = function (data) {
                $('#canvas').drawArc({
                    fillStyle: "rgba(" + data.fill.r + ", " + data.fill.g + ", " + data.fill.b + ", 0.5)",
                    x: data.x, y: data.y,
                    radius: data.radius
                });
            };

            $.connection.hub.start().done(function () {
                $(function () {
                    $('#openme').click(function () {
                        window.open('@Request.Url.AbsoluteUri', '_new', false)
                    });

                    var mouseX = 0;
                    var mouseY = 0;
                    var sending = false;

                    document.addEventListener('mousemove', onMouseMove, false)

                    function onMouseMove(e) {
                        mouseX = e.clientX;
                        mouseY = e.clientY;
                    }

                    function getMousePosOnTarget(canvasTarget) {
                        var rect = canvasTarget.getBoundingClientRect();
                        return {
                            x: mouseX - rect.left,
                            y: mouseY - rect.top
                        };
                    };

                    var canvas = document.getElementById('canvas');

                    function sendLoop() {
                        if (sending) {
                            var mousePos = getMousePosOnTarget(canvas);
                            image.server.sendPaint(Math.floor(mousePos.x), Math.floor(mousePos.y)); // TODO: RGB
                            setTimeout(sendLoop, 50);
                        }
                    };

                    document.addEventListener('mousedown', function (evt) {
                        sending = true;
                        sendLoop();
                    });

                    document.addEventListener('mouseup', function (evt) {
                        sending = false;
                    });
                });
            });
        });
    </script>
}